<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Editor · {{ project_id }} · gor://a</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ================= CodeMirror (stable) ================= -->
<script type="module">
  import { EditorState } from "https://esm.sh/@codemirror/state";
  import { EditorView, keymap, lineNumbers } from "https://esm.sh/@codemirror/view";
  import { defaultKeymap, history, historyKeymap } from "https://esm.sh/@codemirror/commands";
  import { oneDark } from "https://esm.sh/@codemirror/theme-one-dark";

  window.createEditor = (parent, content) => {
    const fill = EditorView.theme({
      "&": { height: "100%" },
      ".cm-scroller": { overflow: "auto" }
    });

    const state = EditorState.create({
      doc: content,
      extensions: [
        fill,
        lineNumbers(),
        history(),
        keymap.of([...defaultKeymap, ...historyKeymap]),
        oneDark,
        EditorView.lineWrapping
      ]
    });

    return new EditorView({ state, parent });
  };
</script>

<style>
body{margin:0;background:#0b1020;color:#fff;height:100vh;overflow:hidden;font-family:system-ui}
.shell{display:flex;height:100vh}

/* LEFT */
.left{width:380px;background:#0f1530;border-right:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column}
header{padding:16px;border-bottom:1px solid rgba(255,255,255,.08)}
.phases{display:flex;gap:8px;padding:12px}
.phase{padding:6px 12px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.12);opacity:.3}
.phase.active{border-color:#3b6cff;opacity:1}

.chat{flex:1;padding:14px;overflow:auto;display:flex;flex-direction:column;gap:10px}
.msg{max-width:85%;padding:10px 12px;border-radius:14px;font-size:13px}
.msg.user{align-self:flex-end;background:#3b6cff}
.msg.agent{align-self:flex-start;background:rgba(255,255,255,.06)}
.msg.system{align-self:center;font-size:12px;opacity:.6}

.agent-input{padding:12px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:8px}
textarea{flex:1;height:70px;border-radius:12px;background:#0b1020;color:#fff;border:1px solid rgba(255,255,255,.12);padding:10px}
button{background:#3b6cff;border:none;color:#fff;border-radius:12px;padding:14px 16px;cursor:pointer}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column}
.topbar{height:56px;display:flex;gap:8px;align-items:center;padding:0 16px;border-bottom:1px solid rgba(255,255,255,.08)}
.tab{padding:8px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);cursor:pointer;opacity:.7}
.tab.active{border-color:#3b6cff;opacity:1}

.content{flex:1;display:flex}
.files{width:240px;background:#0f1530;border-right:1px solid rgba(255,255,255,.08);padding:12px}
.file{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);margin-bottom:6px;font-size:12px;cursor:pointer}
.file.active{border-color:#3b6cff}

.stage{flex:1}
#editor{height:100%}
#preview{width:100%;height:100%;border:0;display:none;background:#fff}
</style>
</head>

<body>
<div class="shell">

<aside class="left">
  <header>
    <div>gor://a agent</div>
    <div style="font-size:12px;opacity:.6">{{ project_id }}</div>
  </header>

  <div class="phases">
    <div class="phase" id="phase-planner">Planner</div>
    <div class="phase" id="phase-coder">Coder</div>
    <div class="phase" id="phase-files">Files</div>
  </div>

  <div class="chat" id="chat"></div>

  <div class="agent-input">
    <textarea id="prompt" placeholder="Describe what to build or change…"></textarea>
    <button id="runAgent">▶</button>
  </div>
</aside>

<section class="main">
  <div class="topbar">
    <div class="tab active" id="tabCode">Code</div>
    <div class="tab" id="tabPreview">Preview</div>
  </div>

  <div class="content">
    <aside class="files" id="filelist"></aside>
    <div class="stage">
      <div id="editor"></div>
      <iframe id="preview"></iframe>
    </div>
  </div>
</section>

</div>

<script>
const PROJECT_ID = "{{ project_id }}";
let editorView=null, currentFile="index.html", es=null;

const $=id=>document.getElementById(id);
const chat=$("chat");

function add(role,text){
  const d=document.createElement("div");
  d.className="msg "+role;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

function setPhase(p){
  ["planner","coder","files"].forEach(x=>{
    $("phase-"+x).classList.toggle("active",x===p);
  });
}

/* FILES */
async function refreshFiles(){
  const r=await fetch(`/api/project/${PROJECT_ID}/files`);
  const d=await r.json();
  $("filelist").innerHTML="";
  (d.files||[]).forEach(f=>{
    const el=document.createElement("div");
    el.className="file"+(f.path===currentFile?" active":"");
    el.textContent=f.path;
    el.onclick=()=>loadFile(f.path);
    $("filelist").appendChild(el);
  });
}

async function loadFile(p){
  currentFile=p;
  const r=await fetch(`/api/project/${PROJECT_ID}/file?path=${encodeURIComponent(p)}`);
  const d=await r.json();
  $("editor").innerHTML="";
  editorView=window.createEditor($("editor"), d.content||"");
  refreshFiles();
}

/* TABS */
$("tabCode").onclick=()=>{
  $("editor").style.display="block";
  $("preview").style.display="none";
  $("tabCode").classList.add("active");
  $("tabPreview").classList.remove("active");
};
$("tabPreview").onclick=()=>{
  $("editor").style.display="none";
  $("preview").style.display="block";
  $("preview").src=`/app/${PROJECT_ID}/index.html?ts=${Date.now()}`;
  $("tabPreview").classList.add("active");
  $("tabCode").classList.remove("active");
};

/* AGENT */
function startStream(){
  if(es) es.close();
  es=new EventSource(`/api/project/${PROJECT_ID}/events`);
  add("system","Agent connected");

  es.onmessage=e=>{
    const m=JSON.parse(e.data);

    if(m.type==="status"){
      add("system",m.text);
      if(m.text.includes("Planning")) setPhase("planner");
      if(m.text.includes("Coding")) setPhase("coder");
      if(m.text.includes("Done")) setPhase("files");
    }

    if(m.type==="log"){
      add(m.role||"agent",m.text);
    }

    if(m.type==="file_changed"){
      add("system","Updated: "+m.path);
      refreshFiles();
      if(m.path===currentFile) loadFile(currentFile);
    }
  };

  es.onerror=()=>add("system","Agent stream disconnected");
}

$("runAgent").onclick=async()=>{
  const p=$("prompt").value.trim();
  if(!p) return;
  add("user",p);
  $("prompt").value="";
  await fetch(`/api/project/${PROJECT_ID}/agent/start`,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({prompt:p})
  });
  startStream();
};

/* BOOT */
(async()=>{
  await refreshFiles();
  await loadFile(currentFile);
})();
</script>
</body>
</html>
