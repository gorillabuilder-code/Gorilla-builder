<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Editor ¬∑ {{ project_id }} ¬∑ gor://a</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1594181130407895" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<script type="module">
  import { EditorState } from "https://esm.sh/@codemirror/state";
  import { EditorView, keymap, lineNumbers } from "https://esm.sh/@codemirror/view";
  import { defaultKeymap, history, historyKeymap } from "https://esm.sh/@codemirror/commands";
  import { oneDark } from "https://esm.sh/@codemirror/theme-one-dark";
  import { javascript } from "https://esm.sh/@codemirror/lang-javascript";
  import { html } from "https://esm.sh/@codemirror/lang-html";
  import { css } from "https://esm.sh/@codemirror/lang-css";

  window.createEditor = (parent, content, onChange, fileName) => {
    const fixedHeightEditor = EditorView.theme({
      "&": { height: "100%", fontSize: "14px", backgroundColor: "transparent" },
      ".cm-scroller": { overflow: "auto" },
      ".cm-gutters": { backgroundColor: "transparent", borderRight: "1px solid rgba(255,255,255,0.05)", color: "#565f89" }
    });

    let extensions = [
        fixedHeightEditor,
        lineNumbers(),
        history(),
        keymap.of([...defaultKeymap, ...historyKeymap]),
        oneDark,
        EditorView.lineWrapping,
        EditorView.updateListener.of((v) => {
          if (v.docChanged && typeof onChange === "function") {
            onChange(v.state.doc.toString());
          }
        })
    ];

    if (fileName) {
        if (fileName.endsWith('.js') || fileName.endsWith('.tsx') || fileName.endsWith('.ts') || fileName.endsWith('.json')) {
            extensions.push(javascript());
        } else if (fileName.endsWith('.html')) {
            extensions.push(html());
        } else if (fileName.endsWith('.css')) {
            extensions.push(css());
        }
    }

    const state = EditorState.create({
      doc: content,
      extensions: extensions
    });

    return new EditorView({ state, parent });
  };
</script>

<style>
/* --- 1. FONTS & RESETS --- */
@font-face {
  font-family: 'din-next-w01-light';
  src: url('//static.parastorage.com/fonts/v2/eca8b0cd-45d8-43cf-aee7-ca462bc5497c/v1/din-next-w02-light.woff2') format('woff2');
  font-display: swap;
}

:root {
  /* Core Palette - Deep Space Theme */
  --bg: #020408;
  --panel: rgba(13, 17, 28, 0.85); /* Glassy panel */
  --panel-solid: #0d111c;
  --panel-light: rgba(20, 25, 40, 0.6);
  --border: rgba(255, 255, 255, 0.08);
  --glass: blur(12px) saturate(180%);
  
  /* Status Colors */
  --danger: #ff4d6d;
  --ok: #00f0aa;
  --warn: #ffcc00;
  
  /* Text */
  --text: #ececf1;
  --text-muted: #8b949e;

  /* Default Theme (Electric Blue) */
  --accent: #3b82f6;
  --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --accent-glow: rgba(59, 130, 246, 0.3);
  
  /* Role Colors */
  --coder-bg: rgba(45, 212, 191, 0.1);
  --coder-border: rgba(45, 212, 191, 0.3);
  --coder-text: #2dd4bf;
  
  --planner-bg: rgba(250, 204, 21, 0.1);
  --planner-border: rgba(250, 204, 21, 0.3);
  --planner-text: #facc15;
}

* { box-sizing: border-box; font-family: 'din-next-w01-light', system-ui, -apple-system, sans-serif; outline: none; }

/* --- 2. LAYOUT & BODY --- */
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
  background-image: 
    radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 100% 100%, rgba(124, 58, 237, 0.08) 0%, transparent 50%);
  font-size: 13px;
}

.shell { display: flex; height: 100vh; width: 100%; overflow: hidden; }

/* --- 3. THEME OVERRIDES --- */
body.premium {
  --accent: #ffd700; 
  --accent-gradient: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
  --accent-glow: rgba(255, 215, 0, 0.25);
}
body.premium .msg.user { color: #000; font-weight: 600; }
body.premium .agent-input button { color: #000; }

body.xmode {
  --bg: #05010a;
  --panel: rgba(18, 5, 34, 0.9);
  --panel-light: rgba(30, 10, 50, 0.5);
  --accent: #d946ef;
  --accent-gradient: linear-gradient(135deg, #d946ef 0%, #a855f7 100%);
  --accent-glow: rgba(217, 70, 239, 0.4);
  --border: rgba(217, 70, 239, 0.15);
  background-image: radial-gradient(circle at 50% 0%, rgba(217, 70, 239, 0.1) 0%, transparent 60%) !important;
}

/* --- 4. LEFT SIDEBAR (AGENT) --- */
.left {
  width: 420px;
  min-width: 380px;
  background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  backdrop-filter: var(--glass);
  position: relative;
  z-index: 20;
}

.left header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  background: rgba(0,0,0,0.2);
}

.hgroup .t { 
  font-size: 16px; font-weight: 600; letter-spacing: -0.5px; 
  display: flex; align-items: center; gap: 8px; color: #fff;
}
.header-actions { display: flex; gap: 6px; }

/* UI Elements */
.pill {
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.03);
  color: var(--text-muted);
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  gap: 6px;
  align-items: center;
  transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
  font-weight: 500;
}
.pill:hover { 
  border-color: rgba(255,255,255,0.2); 
  color: #fff; 
  background: rgba(255,255,255,0.08); 
  transform: translateY(-1px);
}

.dot { width: 6px; height: 6px; border-radius: 999px; background: var(--text-muted); box-shadow: 0 0 0 2px rgba(0,0,0,0.2); }
.dot.ok { background: var(--ok); box-shadow: 0 0 8px rgba(0, 240, 170, 0.4); }
.dot.warn { background: var(--warn); }
.dot.bad { background: var(--danger); }

/* Phases & Progress */
.phases {
  display: flex; gap: 4px; padding: 10px 20px;
  border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.1);
}
.phase {
  flex: 1;
  padding: 6px 0; border-radius: 6px; font-size: 10px;
  text-transform: uppercase; letter-spacing: 0.5px;
  text-align: center;
  border: 1px solid transparent; color: var(--text-muted); opacity: 0.5; transition: all 0.3s;
  background: rgba(255,255,255,0.02);
}
.phase.active {
  border-color: var(--accent); 
  background: rgba(59, 130, 246, 0.08);
  color: var(--accent); opacity: 1; font-weight: 700; 
}

.progress {
  padding: 12px 20px; border-bottom: 1px solid var(--border);
  display: flex; flex-direction: column; gap: 8px;
  background: rgba(0,0,0,0.05);
}
.progress-row { display: flex; align-items: center; justify-content: space-between; }
.progress-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
.progress-status { font-size: 11px; color: var(--accent); font-weight: 600; text-shadow: 0 0 10px var(--accent-glow); }

.bar-bg { height: 4px; border-radius: 999px; background: rgba(255,255,255,0.05); overflow: hidden; }
.bar-fill {
  height: 100%; width: 0%;
  background: var(--accent-gradient);
  border-radius: 999px; transition: width 0.4s ease-out; box-shadow: 0 0 12px var(--accent-glow);
}

/* Loading Animation */
.loading-wave { display: flex; align-items: center; gap: 3px; height: 10px; opacity: 0; transition: opacity 0.3s; }
.loading-wave.active { opacity: 1; }
.loading-bar { width: 3px; height: 8px; background: var(--accent); border-radius: 2px; animation: wave 1s infinite ease-in-out; }
.loading-bar:nth-child(2) { animation-delay: 0.1s; }
.loading-bar:nth-child(3) { animation-delay: 0.2s; }
@keyframes wave { 0%, 100% { transform: scaleY(1); opacity: 0.5; } 50% { transform: scaleY(2); opacity: 1; } }

/* Chat Area */
.chat { 
    flex: 1; 
    padding: 20px; 
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    gap: 16px; 
    scroll-behavior: smooth; 
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 100%);
}

.msg {
  max-width: 94%; padding: 14px 18px; border-radius: 16px; font-size: 13.5px; line-height: 1.6; word-break: break-word;
  animation: slideIn 0.3s ease-out; position: relative;
}
@keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.msg.user { 
  align-self: flex-end; 
  background: var(--accent-gradient); 
  color: #fff; 
  border: 1px solid rgba(255,255,255,0.1); 
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  border-bottom-right-radius: 4px;
}
.msg.agent, .msg.assistant { 
  align-self: flex-start; 
}
.msg.coder { 
    align-self: flex-start; 
    background: #0f131a; 
    border: 1px solid var(--coder-border); 
    border-left: 3px solid var(--coder-text);
    font-family: monospace;
}
.msg.planner { align-self: flex-start; }
.msg.system { 
    align-self: center; font-size: 11px; color: var(--text-muted); 
    border-radius: 999px; padding: 4px 12px; margin: 8px 0; box-shadow: none; 
}

.meta { 
    font-size: 10px; opacity: 0.7; margin-bottom: 6px; 
    text-transform: uppercase; font-weight: 700; letter-spacing: 0.8px; 
    display: flex; align-items: center; gap: 6px; 
}
.msg.coder .meta { color: var(--coder-text); }
.msg.planner .meta { color: var(--planner-text); }

/* Markdown Styles inside Chat */
.md p { margin: 0 0 10px 0; }
.md p:last-child { margin: 0; }
.md strong { color: #fff; font-weight: 600; }
.md code { 
    background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; 
    font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #e2e8f0;
    border: 1px solid rgba(255,255,255,0.1);
}
.md pre { 
    background: #080a0f; padding: 12px; border-radius: 8px; 
    overflow-x: auto; border: 1px solid var(--border); margin: 8px 0; 
}
.md pre code { background: none; border: none; padding: 0; color: #a5b3ce; }

/* Agent Input Area */
.agent-input { 
    padding: 20px; 
    border-top: 1px solid var(--border); 
    display: flex; gap: 12px; 
    background: rgba(10, 12, 18, 0.95);
    position: relative;
    z-index: 50;
}
.agent-input::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), transparent);
}

.agent-input textarea {
  flex: 1; height: 50px; min-height: 50px; max-height: 150px; resize: vertical;
  border-radius: 12px; border: 1px solid var(--border); 
  background: rgba(0,0,0,0.3); color: #fff; padding: 14px;
  font-size: 14px; transition: all 0.2s;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}
.agent-input textarea:focus { border-color: var(--accent); background: rgba(0,0,0,0.5); box-shadow: 0 0 0 2px var(--accent-glow); }
.agent-input textarea::placeholder { color: rgba(255,255,255,0.3); }

.agent-input button {
  background: var(--accent-gradient); 
  border: none; color: #fff; border-radius: 12px; width: 50px; height: 50px;
  display: flex; align-items: center; justify-content: center; 
  cursor: pointer; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); 
  box-shadow: 0 4px 12px var(--accent-glow);
}
.agent-input button:hover { transform: scale(1.05) translateY(-2px); filter: brightness(1.1); }
.agent-input button:active { transform: scale(0.95); }

/* --- 5. MAIN AREA --- */
.main { flex: 1; display: flex; flex-direction: column; min-width: 0; background: var(--bg); position: relative; }

/* Top Bar (Editor Tabs) */
.topbar { 
    height: 52px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; 
    border-bottom: 1px solid var(--border); background: var(--panel-solid); 
}
.tabs { display: flex; gap: 4px; padding: 4px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid var(--border); }
.tab {
  padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;
  color: var(--text-muted); transition: all 0.2s; border: 1px solid transparent;
}
.tab:hover { color: #fff; }
.tab.active { 
    background: rgba(255,255,255,0.08); 
    border-color: rgba(255,255,255,0.05); 
    color: #fff; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.tab.link { background: none; border: none; padding: 0; box-shadow: none; margin-left: 12px; }
.previewMode { display: flex; gap: 8px; align-items: center; margin-left: 16px; padding-left: 16px; border-left: 1px solid var(--border); }

.select { 
    background: #050810; border: 1px solid var(--border); color: #fff; 
    border-radius: 6px; padding: 6px 10px; font-size: 12px; 
    cursor: pointer; transition: border 0.2s;
}
.select:hover { border-color: rgba(255,255,255,0.2); }

.smallbtn { 
    border: 1px solid var(--border); background: rgba(255,255,255,0.03); 
    color: #fff; border-radius: 6px; padding: 6px 12px; font-size: 11px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; 
}
.smallbtn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.2); }
.smallbtn.danger { border-color: rgba(255, 77, 109, 0.3); color: var(--danger); }
.smallbtn.danger:hover { background: rgba(255, 77, 109, 0.1); border-color: var(--danger); }

.badge { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: rgba(255,255,255,0.03); border-radius: 4px; }

/* Content Grid */
.content { flex: 1; display: flex; min-height: 0; }

/* File Tree */
.files { 
    width: 240px; min-width: 200px; 
    background: var(--panel-light); 
    border-right: 1px solid var(--border); 
    display: flex; flex-direction: column; 
    backdrop-filter: blur(10px);
}
.tree-header { 
    padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; 
    border-bottom: 1px solid var(--border); 
}
.treeTitle { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 1px; }

.upload-btn { 
    background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); 
    color: var(--accent); cursor: pointer; font-size: 11px; padding: 4px 10px; 
    border-radius: 4px; transition: all 0.2s; font-weight: 600;
}
.upload-btn:hover { background: var(--accent); color: #fff; }

.file-list { padding: 10px; overflow-y: auto; flex: 1; }
.node { 
    display: flex; align-items: center; gap: 8px; padding: 6px 10px; 
    border-radius: 6px; cursor: pointer; font-size: 13px; color: #94a3b8; 
    transition: all 0.15s; margin-bottom: 2px;
}
.node:hover { background: rgba(255,255,255,0.04); color: #fff; transform: translateX(2px); }
.node.active { 
    background: rgba(59, 130, 246, 0.15); color: #fff; 
    font-weight: 500;
}
.ico { opacity: 0.7; font-size: 14px; }

/* Editor & Preview Stage */
.stage { flex: 1; min-width: 0; background: #0d111c; position: relative; display: flex; flex-direction: column; }
#editor { flex: 1; height: 100%; overflow: hidden; }
#preview { width: 100%; height: 100%; border: 0; display: none; background: #fff; }

/* --- 6. AD STYLES (Cleaned Up) --- */
.ad-strip-horiz {
    background: #000;
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: center; align-items: center;
    padding: 10px; width: 100%; min-height: 90px;
}
.ad-box-square {
    margin: 10px; background: rgba(0,0,0,0.5);
    border: 1px solid var(--border); border-radius: 8px;
    display: flex; justify-content: center; align-items: center;
    min-height: 200px;
}

/* Scrollbar Customization */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
</style>
</head>

<body class="{% if user.plan == 'premium' %}premium{% endif %} {% if xmode %}xmode{% endif %}">
<div class="shell">

<aside class="left">
  <header>
    <div class="hgroup">
      <div class="t">
        <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 600 600" style="filter: drop-shadow(0 0 5px var(--accent));"> 
            <g transform="translate(0.000000,603.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none"> <path d="M1497 6023 c827 -2 2179 -2 3005 0 827 1 151 2 -1502 2 -1653 0 -2329 -1 -1503 -2z"/> <path d="M2802 5273 c-43 -24 -131 -143 -182 -246 -99 -202 -106 -410 -19 -598 59 -128 153 -189 246 -158 56 18 81 37 108 84 34 57 32 112 -6 216 -54 145 -51 327 7 490 41 113 27 176 -46 214 -38 20 -68 19 -108 -2z"/> <path d="M3290 5268 c-74 -50 -185 -230 -228 -369 -44 -142 -37 -293 19 -440 52 -134 141 -208 234 -195 131 20 194 151 136 281 -67 150 -67 316 0 522 26 80 29 98 20 126 -28 83 -116 119 -181 75z"/> <path d="M685 4560 c-171 -34 -283 -139 -331 -306 -15 -50 -18 -129 -23 -519 -4 -321 -10 -466 -18 -480 -32 -56 -64 -70 -205 -90 -26 -4 -46 -17 -72 -45 -33 -36 -36 -45 -36 -99 0 -98 62 -161 157 -161 59 0 119 -26 146 -64 22 -31 22 -35 28 -496 5 -424 8 -471 26 -531 11 -37 31 -87 46 -111 72 -124 228 -198 418 -198 125 0 200 111 151 223 -26 59 -64 82 -148 90 -73 7 -116 27 -148 70 -20 28 -21 41 -27 490 -6 505 -8 526 -68 632 l-28 50 28 50 c60 106 62 128 68 630 6 427 7 462 25 491 26 44 68 65 139 71 81 7 131 35 157 88 26 53 25 91 -2 145 -32 61 -73 80 -168 79 -41 -1 -93 -5 -115 -9z"/> <path d="M5102 4550 c-68 -42 -92 -135 -54 -209 26 -52 60 -72 140 -81 83 -9 128 -32 157 -80 19 -33 20 -56 26 -500 6 -505 6 -513 66 -621 l26 -45 -26 -45 c-59 -103 -61 -113 -67 -619 -5 -461 -5 -465 -28 -501 -28 -45 -72 -67 -156 -77 -111 -14 -160 -66 -153 -165 4 -66 26 -103 78 -130 28 -15 50 -18 124 -13 218 12 351 101 416 278 22 61 23 74 28 533 6 503 6 500 58 547 19 18 78 34 155 43 33 4 56 15 78 35 29 27 30 31 30 118 0 88 -1 91 -31 116 -33 28 -45 32 -127 40 -66 7 -110 31 -137 76 -19 33 -20 56 -26 505 -6 496 -6 500 -55 598 -70 138 -221 217 -414 217 -57 0 -83 -5 -108 -20z"/> <path d="M1965 3849 c-113 -9 -166 -24 -280 -79 -312 -150 -493 -462 -471 -810 13 -209 89 -379 238 -529 161 -163 321 -236 545 -248 269 -14 478 70 667 267 61 65 95 111 130 179 70 136 89 217 89 386 0 124 -3 151 -27 230 -53 176 -145 314 -282 425 -174 139 -372 197 -609 179z m214 -324 c173 -46 319 -185 372 -354 23 -76 28 -212 9 -282 -50 -186 -208 -340 -391 -384 -181 -42 -372 15 -499 152 -100 106 -144 218 -143 363 1 290 228 517 518 519 44 0 104 -6 134 -14z"/> <path d="M3880 3849 c-190 -17 -341 -86 -488 -224 -112 -104 -200 -249 -239 -395 -25 -92 -25 -339 0 -430 78 -281 316 -519 597 -597 101 -28 339 -25 443 5 152 44 285 128 397 250 146 158 211 332 212 557 0 244 -82 436 -259 606 -181 175 -402 251 -663 228z m213 -324 c282 -73 454 -362 382 -640 -45 -171 -179 -312 -355 -371 -80 -27 -243 -25 -324 5 -202 73 -337 252 -353 466 -17 243 150 475 388 539 71 19 191 20 262 1z"/> </g> 
        </svg> 
        <span> Gor://a {% if xmode %}X{% endif %}</span>
      </div>
    </div>

    <div class="header-actions">
      <a class="pill" href="/projects/{{ project_id }}/settings" title="Project settings">‚öô</a>
      
      {% if user.plan == 'premium' %}
      <button class="pill" id="btnExportZip" style="color: #ffd700;" title="Export project to ZIP">
        ‚¨á ZIP
      </button>
      {% endif %}
      <a class="pill" href="/projects/{{ project_id }}/game" target="_blank" style="background: rgba(255,0,0,0.1); color: var(--danger); border-color: rgba(255,0,0,0.3);" title="Play game">
        PLAY
      </a>
      <span class="pill" id="connPill" title="SSE connection" style="cursor: default;">
        <span class="dot warn" id="connDot"></span>
      </span>
    </div>
  </header>

  <div class="phases">
    <div class="phase" id="phase-planner">Planner</div>
    <div class="phase" id="phase-coder">Coder</div>
    <div class="phase" id="phase-files">Files</div>
  </div>

  <div class="progress">
    <div class="progress-row">
      <div class="progress-title">
        Status
        <div class="loading-wave" id="loadingWave">
          <div class="loading-bar"></div>
          <div class="loading-bar"></div>
          <div class="loading-bar"></div>
        </div>
      </div>
      <div class="progress-status" id="progressText">Idle</div>
    </div>
    <div class="bar-bg">
      <div class="bar-fill" id="progressBar"></div>
    </div>
  </div>

  <div class="chat" id="chat"></div>

  <div class="agent-input">
    <textarea id="prompt" placeholder="What shall we build?"></textarea>
    <button id="runAgent" title="Run agent">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
      </svg>
    </button>
  </div>
</aside>

<section class="main">
  
  {% if user.plan != 'premium' %}
  <div class="ad-strip-horiz">
      <ins class="adsbygoogle"
           style="display:inline-block;width:728px;height:90px"
           data-ad-client="ca-pub-1594181130407895"
           data-ad-slot="1944431541"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>
  {% endif %}

  <div class="topbar">
    <div class="tabs">
      <div class="tab active" id="tabCode">Code</div>
      <div class="tab" id="tabPreview">Preview</div>
    </div>

    <div style="display:flex; align-items:center;">
       <div class="previewMode" id="previewModeWrap" style="display:none; border:none; padding-left:0; margin-left:0; margin-right: 20px;">
        <select class="select" id="previewMode">
          <option value="server">Server Preview</option>
        </select>
        <button class="smallbtn" id="btnRunServer" style="margin-left:8px;">‚ñ∂ Run</button>
        <button class="smallbtn danger" id="btnStopServer" style="margin-left:4px;">‚èπ Stop</button>
        <span class="badge" id="serverStatus" style="margin-left:8px;">stopped</span>
      </div>

      <div style="display:flex; gap:12px; align-items:center;">
        {% if user and user.tokens %}
        <span class="badge" title="Tokens used this month">
          ‚ö° <span id="tokenDisplay">{{ "{:,}".format(user.tokens.used) }}</span>
        </span>
        {% endif %}
        
        <span class="badge" id="saveStatus">Saved</span>
              <a class="pill" href="/dashboard" target="_blank">
          Dashboard
        </a>
        {% if user.plan != 'premium' %}
          <a class="pill" style= "background-color:var(--accent); color:#fff; border-color:var(--accent);" href="/pricing" target="_blank">
            UPGRADE
          </a>
        {% endif %}
        
        {% if user.plan != 'free' %}
        <a class="pill" href="/projects/{{ project_id }}/xmode" style="border-color: #d946ef; color: #d946ef;">
            Xmode
        </a>
        {% endif %}
        
        <a class="pill" href="/app/{{ project_id if not project.subdomain else project.subdomain }}/" target="_blank">
          Open App ‚Üó
        </a>
      </div>
    </div>
  </div>


  <div class="content">
    <aside class="files">
      <div class="tree-header">
        <div class="treeTitle">Explorer</div>
        <button class="upload-btn" id="btnUpload" title="Upload file">+ Upload</button>
        <input type="file" id="uploadInput" hidden />
      </div>
      <div class="file-list" id="filetree"></div>

      {% if user.plan != 'premium' %}
      <div class="ad-box-square">
         <ins class="adsbygoogle"
              style="display:inline-block;width:200px;height:200px"
              data-ad-client="ca-pub-1594181130407895"
              data-ad-slot="1944431541"></ins>
         <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>
      {% endif %}
    </aside>

    <div class="stage">
      <div id="editor"></div>
      <iframe id="preview"></iframe>
    </div>
  </div>


</section>

</div>

<script>
const PROJECT_ID = "{{ project_id }}";
const INITIAL_PROMPT = "{{ initial_prompt or '' }}"; 
const CHAT_KEY = `gorilla_chat_${PROJECT_ID}`;

let editorView = null;
let currentFile = "index.html"; 
let currentContent = "";
let dirty = false;
let es = null;
let saveTimer = null;

const $ = (id) => document.getElementById(id);
const chat = $("chat");

function loadChatHistory() {
  try {
    const raw = localStorage.getItem(CHAT_KEY);
    if (raw) {
      const history = JSON.parse(raw);
      if (Array.isArray(history)) {
        history.forEach(m => addMessage(m.role, m.text, false));
        chat.scrollTop = chat.scrollHeight;
      }
    }
  } catch (e) { console.error(e); }
}

function saveChatHistory(role, text) {
  try {
    const raw = localStorage.getItem(CHAT_KEY);
    const history = raw ? JSON.parse(raw) : [];
    history.push({ role, text });
    if(history.length > 50) history.shift();
    localStorage.setItem(CHAT_KEY, JSON.stringify(history));
  } catch (e) { console.error(e); }
}

function setConn(state){
  const dot = $("connDot");
  const pill = $("connPill");
  
  if(state === "ok"){
    dot.className = "dot ok";
    pill.title = "Live";
  } else if(state === "bad"){
    dot.className = "dot bad";
    pill.title = "Offline";
  } else {
    dot.className = "dot warn";
    pill.title = "Connecting‚Ä¶";
  }
}

function setPhase(p) {
  ["planner","coder","files"].forEach(x =>
    $("phase-"+x).classList.toggle("active", x === p)
  );
}

function setProgress(text, pct){
  if(text) $("progressText").textContent = text;
  if(pct !== undefined) {
    const v = Math.max(0, Math.min(100, Number(pct)));
    $("progressBar").style.width = v + "%";
  }
  
  const wave = $("loadingWave");
  if(wave) {
      const isWorking = text && !text.includes("Idle") && !text.includes("Done") && !text.includes("Complete");
      wave.classList.toggle("active", isWorking);
  }
}

function setSaveStatus(){
  const el = $("saveStatus");
  if(dirty) {
    el.textContent = "Unsaved";
    el.style.color = "var(--warn)";
  } else {
    el.textContent = "Saved";
    el.style.color = "var(--text-muted)";
  }
}

function updateTokens(newTotal) {
  const el = $("tokenDisplay");
  if(el) {
    const isError = String(newTotal).toLowerCase().includes("error") || String(newTotal).toLowerCase().includes("limit");
    el.textContent = isError ? "Limit Reached" : (newTotal);
    el.style.color = isError ? "var(--danger)" : "var(--text)";
    if(!isError) setTimeout(() => el.style.color = "", 1000); 
  }
}

function addMessage(role, text, save=true){
  const el = document.createElement("div");
  el.className = "msg " + role;

  if(role === "system"){
    el.textContent = text;
  } else {
    const safeHtml = DOMPurify.sanitize(marked.parse(text || ""));
    el.innerHTML = `<div class="meta">${role}</div><div class="md">${safeHtml}</div>`;
  }

  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
  
  if(save && role !== "system") {
    saveChatHistory(role, text);
  }
}

async function fetchJSON(url, opts){
  const r = await fetch(url, opts);
  const t = await r.text();
  try { return JSON.parse(t); } catch { return { raw: t, ok: r.ok }; }
}

function buildTree(paths){
  const root = {};
  for(const p of paths){
    const parts = p.split("/").filter(Boolean);
    let cur = root;
    for(let i=0;i<parts.length;i++){
      const part = parts[i];
      const isFile = (i === parts.length - 1);
      cur[part] = cur[part] || { __children: {}, __file: false, __path: null };
      if(isFile){
        cur[part].__file = true;
        cur[part].__path = p;
      }
      cur = cur[part].__children;
    }
  }
  return root;
}

function renderTree(container, nodeObj, depth){
  const entries = Object.entries(nodeObj).sort(([a],[b]) => a.localeCompare(b));
  for(const [name, meta] of entries){
    const hasKids = meta.__children && Object.keys(meta.__children).length > 0;
    const isFile = !!meta.__file;

    const row = document.createElement("div");
    row.className = "node" + ((isFile && meta.__path === currentFile) ? " active" : "");
    row.style.paddingLeft = (10 + (depth * 14)) + "px";

    const ico = document.createElement("span");
    ico.className = "ico";
    ico.textContent = isFile ? "üìÑ" : "üìÅ";
    
    // Better icons if possible
    if(isFile) {
        if (name.endsWith('.js')) {
    ico.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0 0 48 48"> <path fill="#ffd600" d="M6,42V6h36v36H6z"></path><path fill="none" stroke="#000001" stroke-miterlimit="10" stroke-width="3.3" d="M23.783,22.352v9.819 c0,3.764-4.38,4.022-6.283,0.802"></path><path fill="none" stroke="#000001" stroke-miterlimit="10" stroke-width="3.3" d="M34.69,25.343 c-1.739-2.727-5.674-2.345-5.84,0.558c-0.214,3.757,6.768,2.938,6.247,7.107c-0.365,2.92-4.874,3.858-7.193-0.065"></path> </svg>`;
        }
        if (name.endsWith('.html')) {
    ico.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0 0 48 48"> <path fill="#E65100" d="M41,5H7l3,34l14,4l14-4L41,5L41,5z"></path><path fill="#FF6D00" d="M24 8L24 39.9 35.2 36.7 37.7 8z"></path><path fill="#FFF" d="M24,25v-4h8.6l-0.7,11.5L24,35.1v-4.2l4.1-1.4l0.3-4.5H24z M32.9,17l0.3-4H24v4H32.9z"></path><path fill="#EEE" d="M24,30.9v4.2l-7.9-2.6L15.7,27h4l0.2,2.5L24,30.9z M19.1,17H24v-4h-9.1l0.7,12H24v-4h-4.6L19.1,17z"></path> </svg>`;
        }
        if (name.endsWith('.css')) {
    ico.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0 0 48 48"><path fill="#0277BD" d="M41,5H7l3,34l14,4l14-4L41,5L41,5z"></path><path fill="#039BE5" d="M24 8L24 39.9 35.2 36.7 37.7 8z"></path><path fill="#FFF" d="M33.1 13L24 13 24 17 28.9 17 28.6 21 24 21 24 25 28.4 25 28.1 29.5 24 30.9 24 35.1 31.9 32.5 32.6 21 32.6 21z"></path><path fill="#EEE" d="M24,13v4h-8.9l-0.3-4H24z M19.4,21l0.2,4H24v-4H19.4z M19.8,27h-4l0.3,5.5l7.9,2.6v-4.2l-4.1-1.4L19.8,27z"></path></svg>`;
        }
        if (name.endsWith('.tsx')) {
    ico.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="15" height="15" viewBox="0 0 48 48"><path fill="#80deea" d="M24,34C11.1,34,1,29.6,1,24c0-5.6,10.1-10,23-10c12.9,0,23,4.4,23,10C47,29.6,36.9,34,24,34z M24,16  c-12.6,0-21,4.1-21,8c0,3.9,8.4,8,21,8s21-4.1,21-8C45,20.1,36.6,16,24,16z"></path><path fill="#80deea" d="M15.1,44.6c-1,0-1.8-0.2-2.6-0.7C7.6,41.1,8.9,30.2,15.3,19l0,0c3-5.2,6.7-9.6,10.3-12.4c3.9-3,7.4-3.9,9.8-2.5  c2.5,1.4,3.4,4.9,2.8,9.8c-0.6,4.6-2.6,10-5.6,15.2c-3,5.2-6.7,9.6-10.3,12.4C19.7,43.5,17.2,44.6,15.1,44.6z M32.9,5.4 c-1.6,0-3.7,0.9-6,2.7c-3.4,2.7-6.9,6.9-9.8,11.9l0,0c-6.3,10.9-6.9,20.3-3.6,22.2c1.7,1,4.5,0.1,7.6-2.3c3.4-2.7,6.9-6.9,9.8-11.9  c2.9-5,4.8-10.1,5.4-14.4c0.5-4-0.1-6.8-1.8-7.8C34,5.6,33.5,5.4,32.9,5.4z"></path><path fill="#80deea" d="M33,44.6c-5,0-12.2-6.1-17.6-15.6C8.9,17.8,7.6,6.9,12.5,4.1l0,0C17.4,1.3,26.2,7.8,32.7,19 c3,5.2,5,10.6,5.6,15.2c0.7,4.9-0.3,8.3-2.8,9.8C34.7,44.4,33.9,44.6,33,44.6z M13.5,5.8c-3.3,1.9-2.7,11.3,3.6,22.2  c6.3,10.9,14.1,16.1,17.4,14.2c1.7-1,2.3-3.8,1.8-7.8c-0.6-4.3-2.5-9.4-5.4-14.4C24.6,9.1,16.8,3.9,13.5,5.8L13.5,5.8z"></path><circle cx="24" cy="24" r="4" fill="#80deea"></circle></svg>`;
        }
        if (name.endsWith('.ts')) {
    ico.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="20" height="20" viewBox="0 0 48 48"> <rect width="36" height="36" x="6" y="6" fill="#1976d2"></rect><polygon fill="#fff" points="27.49,22 14.227,22 14.227,25.264 18.984,25.264 18.984,40 22.753,40 22.753,25.264 27.49,25.264"></polygon><path fill="#fff" d="M39.194,26.084c0,0-1.787-1.192-3.807-1.192s-2.747,0.96-2.747,1.986 c0,2.648,7.381,2.383,7.381,7.712c0,8.209-11.254,4.568-11.254,4.568V35.22c0,0,2.152,1.622,4.733,1.622s2.483-1.688,2.483-1.92 c0-2.449-7.315-2.449-7.315-7.878c0-7.381,10.658-4.469,10.658-4.469L39.194,26.084z"></path> </svg>`;
        }
        if(name.endsWith('.json')) ico.textContent = "{ }";
    }

    const label = document.createElement("span");
    label.textContent = name;

    row.appendChild(ico);
    row.appendChild(label);

    if(isFile){
      row.onclick = () => loadFile(meta.__path);
    } else {
      let open = true;
      row.onclick = () => {
        open = !open;
        kids.style.display = open ? "block" : "none";
        ico.textContent = open ? "üìÇ" : "üìÅ";
      };
    }

    container.appendChild(row);

    const kids = document.createElement("div");
    kids.style.display = "block";
    container.appendChild(kids);

    if(hasKids){
      renderTree(kids, meta.__children, depth + 1);
    }
  }
}

async function refreshFiles(){
  const data = await fetchJSON(`/api/project/${PROJECT_ID}/files`);
  const paths = (data.files || []).map(x => x.path);
  
  if (paths.length > 0 && !paths.includes(currentFile)) {
      if (paths.includes('README.md')) currentFile = 'README.md';
      else if (paths.includes('package.json')) currentFile = 'package.json';
      else if (paths.includes('server.js')) currentFile = 'server.js';
      else currentFile = paths[0];
  }

  const tree = buildTree(paths);
  const mount = $("filetree");
  mount.innerHTML = "";
  renderTree(mount, tree, 0);
}

function buildEditor(content, fileName){
  $("editor").innerHTML = "";
  currentContent = content || "";
  dirty = false;
  setSaveStatus();

  if(!window.createEditor){
    addMessage("system", "Editor loading...");
    return;
  }

  editorView = window.createEditor($("editor"), currentContent, (newText) => {
    currentContent = newText;
    dirty = true;
    setSaveStatus();
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => saveCurrentFile(), 800);
  }, fileName);
}

// --- [FIX] ROBUST FILE LOADING ---
async function loadFile(path){
  currentFile = path;
  const data = await fetchJSON(`/api/project/${PROJECT_ID}/file?path=${encodeURIComponent(path)}`);
  
  // Checks if backend sent JSON object OR raw text and handles both
  const content = (data.content !== undefined) ? data.content : (data.raw || "");
  
  buildEditor(content, path);
  await refreshFiles(); 
}

async function saveCurrentFile(){
  if(!dirty) return;
  const form = new URLSearchParams();
  form.set("file", currentFile);
  form.set("content", currentContent);

  const r = await fetch(`/api/project/${PROJECT_ID}/save`, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: form
  });

  if(r.ok){
    dirty = false;
    setSaveStatus();
    await refreshFiles();
  }
}

$("btnUpload").onclick = () => $("uploadInput").click();
$("uploadInput").onchange = (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async (evt) => {
    const form = new URLSearchParams();
    form.set("file", file.name);
    form.set("content", evt.target.result);
    addMessage("system", `Uploading ${file.name}...`);
    await fetch(`/api/project/${PROJECT_ID}/save`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: form
    });
    addMessage("system", "Upload complete.");
    await refreshFiles();
    $("uploadInput").value = "";
  };
  reader.readAsText(file);
};

const btnZip = $("btnExportZip");
if (btnZip) {
  btnZip.onclick = async () => {
    addMessage("system", "Preparing ZIP download...");
    window.location.href = `/api/project/${PROJECT_ID}/export`;
  };
}

function switchTab(tab){
  if(tab === "preview"){
    $("tabPreview").classList.add("active");
    $("tabCode").classList.remove("active");
    $("editor").style.display = "none";
    $("preview").style.display = "block";
    $("previewModeWrap").style.display = "flex";
    refreshPreview();
  } else {
    $("tabCode").classList.add("active");
    $("tabPreview").classList.remove("active");
    $("preview").style.display = "none";
    $("editor").style.display = "block";
    $("previewModeWrap").style.display = "none";
  }
}
$("tabCode").onclick = () => switchTab("code");
$("tabPreview").onclick = () => switchTab("preview");

function refreshPreview(){
  const mode = $("previewMode").value;
  const ts = Date.now();
  $("preview").src = (mode === "server") ? `/run/${PROJECT_ID}/?ts=${ts}` : `/app/${PROJECT_ID}/index.html?ts=${ts}`;
}
$("previewMode").onchange = refreshPreview;

async function serverStatus(){
  const s = await fetchJSON(`/api/project/${PROJECT_ID}/run/status`);
  const el = $("serverStatus");
  if(s && s.running){
    el.textContent = `Running :${s.port}`;
    el.style.color = "var(--ok)";
  } else {
    el.textContent = "Stopped";
    el.style.color = "var(--text-muted)";
  }
}
$("btnRunServer").onclick = async () => {
  addMessage("system", "Starting server...");
  await fetch(`/api/project/${PROJECT_ID}/run/start`, { method: "POST" });
  await serverStatus();
  if($("previewMode").value === "server") refreshPreview();
};
$("btnStopServer").onclick = async () => {
  addMessage("system", "Stopping server...");
  await fetch(`/api/project/${PROJECT_ID}/run/stop`, { method: "POST" });
  await serverStatus();
};

function startStream(){
  if(es) es.close();
  setConn("warn");
  es = new EventSource(`/api/project/${PROJECT_ID}/events`);
  
  es.onopen = () => setConn("ok");
  
  es.onmessage = (e) => {
    const m = JSON.parse(e.data);
    
    if(m.type === "status") {
      addMessage("system", m.text);
      setProgress(m.text);
      if (m.text === "Server Running" || m.text === "Server Fixed & Running") {
          if ($("tabPreview").classList.contains("active")) {
              refreshPreview();
          }
      }
    }
    
    if(m.type === "phase") setPhase(m.value);
    if(m.type === "progress") setProgress(m.text, m.pct);
    
    if(m.type === "log") {
      const role = m.role || "agent";
      addMessage(role, m.text);
    }
    
    if(m.type === "file_changed") {
      setPhase("files");
      refreshFiles();
      if(m.path === currentFile) loadFile(currentFile);
    }
    
    if(m.type === "token_usage") {
      updateTokens(m.used);
    }
  };
  es.onerror = () => setConn("bad");
}

async function triggerAgent(promptText) {
    if(!promptText) return;
    addMessage("user", promptText);
    
    await fetch(`/api/project/${PROJECT_ID}/agent/start`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ prompt: promptText })
    });
    
    startStream();
}

$("runAgent").onclick = () => {
  const p = $("prompt").value.trim();
  if(!p) return;
  $("prompt").value = "";
  triggerAgent(p);
};

$("prompt").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault(); 
        $("runAgent").click();
    }
});

(async () => {
  loadChatHistory();
  await refreshFiles();
  try {
      await loadFile(currentFile);
  } catch(e) {
      console.log("Initial file load failed, waiting for content.");
  }
  
  startStream();
  await serverStatus();
  setProgress("Ready", 0);
  
  if (INITIAL_PROMPT && INITIAL_PROMPT.length > 0) {
      setTimeout(() => {
          triggerAgent(INITIAL_PROMPT);
      }, 1000);
  }
})();
</script>
</body>
</html>