<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Editor · {{ project_id }} · gor://a</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CodeMirror 6 (bundled via skypack) -->
  <script type="module">
    import {EditorView, basicSetup} from "https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/index.js";
    import {EditorState} from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.4.1/dist/index.js";
    import {javascript} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@6.2.2/dist/index.js";
    import {html as htmlLang} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-html@6.4.9/dist/index.js";
    import {css as cssLang} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-css@6.3.0/dist/index.js";
    import {python} from "https://cdn.jsdelivr.net/npm/@codemirror/lang-python@6.1.6/dist/index.js";
    import {oneDark} from "https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.1.2/dist/index.js";

    // Make available to inline scripts
    window.__CM = { EditorView, EditorState, basicSetup, javascript, htmlLang, cssLang, python, oneDark };
  </script>

  <style>
    @font-face{
      font-family:'din-next-w01-light';
      font-style:normal;
      font-weight:400;
      src:url('//static.parastorage.com/fonts/v2/eca8b0cd-45d8-43cf-aee7-ca462bc5497c/v1/din-next-w02-light.woff2') format('woff2');
      font-display:swap;
    }
    *{box-sizing:border-box;font-family:'din-next-w01-light',system-ui,sans-serif}
    body{margin:0;background:#0b1020;color:#fff;height:100vh;overflow:hidden}

    .shell{display:flex;height:100vh;width:100%}

    /* Left bar (agent/progress/chat) */
    .leftbar{
      width:300px;min-width:260px;max-width:360px;
      background:#0f1530;border-right:1px solid rgba(255,255,255,.08);
      display:flex;flex-direction:column
    }
    .brand{
      padding:16px 16px 12px;border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .brand .t{font-size:16px;opacity:.95}
    .brand .id{font-size:12px;opacity:.55}
    .agent{
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;flex-direction:column;gap:10px
    }
    .prompt{
      width:100%;height:92px;resize:none;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:#0b1020;color:#fff;padding:10px 10px;font-size:13px;outline:none
    }
    .row{display:flex;gap:10px;align-items:center}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);color:#fff;font-size:13px;cursor:pointer;text-decoration:none
    }
    .btn.primary{background:#3b6cff;border-color:#3b6cff}
    .btn:hover{border-color:#3b6cff}
    .status{font-size:12px;opacity:.65}
    .log{
      flex:1;overflow:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px
    }
    .msg{
      border:1px solid rgba(255,255,255,.07);
      border-radius:14px;padding:10px 10px;background:rgba(255,255,255,.02)
    }
    .msg .k{font-size:12px;opacity:.6;margin-bottom:6px}
    .msg .v{font-size:13px;opacity:.95;white-space:pre-wrap;word-break:break-word}

    /* Main area */
    .main{flex:1;display:flex;flex-direction:column;min-width:0}

    /* Top bar: tabs + actions */
    .topbar{
      height:54px;min-height:54px;
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.08)
    }

    .tabs{display:flex;gap:8px;align-items:center}
    .tab{
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);cursor:pointer;font-size:13px;opacity:.85
    }
    .tab.active{border-color:#3b6cff;opacity:1}
    .actions{display:flex;gap:10px;align-items:center}
    .pill{
      padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      font-size:12px;opacity:.75
    }

    /* Content split: file list + editor/preview */
    .content{display:flex;flex:1;min-height:0}
    .files{
      width:280px;min-width:240px;max-width:360px;
      border-right:1px solid rgba(255,255,255,.08);
      background:#0f1530;display:flex;flex-direction:column;min-height:0
    }
    .files-head{
      padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between
    }
    .files-head .h{font-size:13px;opacity:.9}
    .filelist{flex:1;overflow:auto;padding:10px}
    .fileitem{
      padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.02);cursor:pointer;margin-bottom:8px
    }
    .fileitem.active{border-color:#3b6cff}
    .fileitem .p{font-size:12px;opacity:.9;word-break:break-all}
    .fileitem .m{font-size:11px;opacity:.55;margin-top:4px}

    .stage{flex:1;min-width:0;display:flex;flex-direction:column;min-height:0}
    .stagebar{
      padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .path{font-size:12px;opacity:.7;word-break:break-all}
    .stagebody{flex:1;min-height:0}
    #editor{height:100%}
    #preview{
      width:100%;height:100%;border:0;background:#fff;display:none
    }

    .hint{font-size:12px;opacity:.6}
  </style>
</head>
<body>

<div class="shell">

  <!-- Left: Agent + Progress -->
  <aside class="leftbar">
    <div class="brand">
      <div>
        <div class="t">gor://a builder</div>
        <div class="id">project: {{ project_id }}</div>
      </div>
      <a class="btn" href="/projects/{{ project_id }}">Back</a>
    </div>

    <div class="agent">
      <textarea id="agentPrompt" class="prompt" placeholder="Tell the agent what to build or change…&#10;Example: add a settings page, wire chat history, add bg remove tool UI"></textarea>
      <div class="row">
        <button class="btn primary" id="runAgent">Run agent</button>
        <button class="btn" id="stopStream">Stop</button>
      </div>
      <div class="status" id="agentStatus">Idle</div>
    </div>

    <div class="log" id="log"></div>
  </aside>

  <!-- Main -->
  <section class="main">

    <div class="topbar">
      <div class="tabs">
        <div class="tab active" id="tabCode">Code</div>
        <div class="tab" id="tabPreview">Preview</div>
      </div>
      <div class="actions">
        <span class="pill" id="saveState">Not saved</span>
        <button class="btn" id="saveBtn">Save</button>
        <a class="btn" href="/projects/{{ project_id }}/preview" target="_blank">Open preview</a>
      </div>
    </div>

    <div class="content">
      <!-- File list -->
      <aside class="files">
        <div class="files-head">
          <div class="h">Files</div>
          <button class="btn" id="refreshFiles">Refresh</button>
        </div>
        <div class="filelist" id="filelist"></div>
      </aside>

      <!-- Editor/Preview -->
      <div class="stage">
        <div class="stagebar">
          <div class="path" id="currentPath">loading…</div>
          <div class="hint">Autosave is off. Save when ready.</div>
        </div>
        <div class="stagebody">
          <div id="editor"></div>
          <iframe id="preview" src="/app/{{ project_id }}/index.html"></iframe>
        </div>
      </div>
    </div>

  </section>
</div>

<script>
  const PROJECT_ID = "{{ project_id }}";
  const initialFile = "{{ file }}";

  let currentFile = initialFile || "index.html";
  let currentContent = "";
  let es = null; // EventSource
  let editorView = null;

  const $ = (id) => document.getElementById(id);

  function log(kind, text) {
    const el = document.createElement("div");
    el.className = "msg";
    el.innerHTML = `<div class="k">${kind}</div><div class="v"></div>`;
    el.querySelector(".v").textContent = text;
    $("log").prepend(el);
  }

  function setSaveState(text) {
    $("saveState").textContent = text;
  }

  function langFor(path) {
    const p = (path || "").toLowerCase();
    if (p.endsWith(".html")) return "html";
    if (p.endsWith(".css")) return "css";
    if (p.endsWith(".js")) return "js";
    if (p.endsWith(".py")) return "py";
    if (p.endsWith(".sql")) return "sql";
    return "txt";
  }

  function buildEditor(value) {
    const CM = window.__CM;
    if (!CM) return;

    let ext = [];
    const l = langFor(currentFile);
    if (l === "html") ext.push(CM.htmlLang());
    if (l === "css") ext.push(CM.cssLang());
    if (l === "js") ext.push(CM.javascript());
    if (l === "py") ext.push(CM.python());

    const state = CM.EditorState.create({
      doc: value || "",
      extensions: [
        CM.basicSetup,
        CM.oneDark,
        ...ext,
        CM.EditorView.updateListener.of((v) => {
          if (v.docChanged) {
            setSaveState("Unsaved changes");
          }
        }),
      ],
    });

    const parent = $("editor");
    parent.innerHTML = "";
    editorView = new CM.EditorView({ state, parent });
    setSaveState("Loaded");
  }

  async function fetchJSON(url) {
    const r = await fetch(url, { credentials: "include" });
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  async function postForm(url, body) {
    const r = await fetch(url, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(body),
    });
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  async function refreshFiles() {
    const data = await fetchJSON(`/api/project/${PROJECT_ID}/files`);
    const files = data.files || [];
    const list = $("filelist");
    list.innerHTML = "";
    files.forEach(f => {
      const item = document.createElement("div");
      item.className = "fileitem" + (f.path === currentFile ? " active" : "");
      item.innerHTML = `<div class="p"></div><div class="m"></div>`;
      item.querySelector(".p").textContent = f.path;
      item.querySelector(".m").textContent = f.updated_at ? `Updated ${f.updated_at}` : "";
      item.onclick = () => loadFile(f.path);
      list.appendChild(item);
    });
  }

  async function loadFile(path) {
    currentFile = path;
    $("currentPath").textContent = path;
    setSaveState("Loading…");
    const data = await fetchJSON(`/api/project/${PROJECT_ID}/file?path=${encodeURIComponent(path)}`);
    currentContent = data.content || "";
    buildEditor(currentContent);
    await refreshFiles();
  }

  async function saveCurrent() {
    if (!editorView) return;
    const content = editorView.state.doc.toString();
    setSaveState("Saving…");
    await postForm(`/api/project/${PROJECT_ID}/save`, { file: currentFile, content });
    setSaveState("Saved");
    log("save", `Saved ${currentFile}`);
    await refreshFiles();
  }

  function setTab(which) {
    const code = $("tabCode");
    const prev = $("tabPreview");
    const iframe = $("preview");
    const editor = $("editor");

    if (which === "preview") {
      code.classList.remove("active");
      prev.classList.add("active");
      editor.style.display = "none";
      iframe.style.display = "block";
      iframe.src = `/app/${PROJECT_ID}/index.html?ts=${Date.now()}`;
    } else {
      prev.classList.remove("active");
      code.classList.add("active");
      iframe.style.display = "none";
      editor.style.display = "block";
    }
  }

  function startStream() {
    if (es) es.close();
    es = new EventSource(`/api/project/${PROJECT_ID}/events`, { withCredentials: true });

    $("agentStatus").textContent = "Streaming…";

    es.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.type === "status") $("agentStatus").textContent = msg.text || "Working…";
        if (msg.type === "log") log(msg.role || "agent", msg.text || "");
        if (msg.type === "file_changed") {
          log("files", `Updated: ${msg.path}`);
          refreshFiles();
          if (msg.path === currentFile) loadFile(currentFile);
        }
      } catch {
        log("stream", ev.data);
      }
    };

    es.onerror = () => {
      $("agentStatus").textContent = "Stream disconnected";
    };
  }

  async function runAgent() {
    const prompt = $("agentPrompt").value.trim();
    if (!prompt) {
      log("ui", "Give the agent a clear build instruction.");
      return;
    }
    log("you", prompt);
    $("agentStatus").textContent = "Starting agent…";

    // Starts planner→coder flow (backend will implement)
    await postForm(`/api/project/${PROJECT_ID}/agent/start`, { prompt });
    startStream();
  }

  $("saveBtn").onclick = saveCurrent;
  $("refreshFiles").onclick = refreshFiles;
  $("tabCode").onclick = () => setTab("code");
  $("tabPreview").onclick = () => setTab("preview");
  $("runAgent").onclick = runAgent;
  $("stopStream").onclick = () => { if (es) es.close(); $("agentStatus").textContent = "Stopped"; };

  // Boot
  (async () => {
    try {
      await refreshFiles();
      await loadFile(currentFile);
      startStream();
      setTab("code");
    } catch (e) {
      log("error", String(e));
      $("agentStatus").textContent = "Error";
    }
  })();
</script>

</body>
</html>
